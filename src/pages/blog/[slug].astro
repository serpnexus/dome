---
import Layout from '../../layouts/Blog.astro';
import { 
  fetchPostBySlug, 
  fetchPosts, 
  getFeaturedImage, 
  getAuthor, 
  formatDate,
  getSEOData 
} from '../../lib/wordpress.js';

export async function getStaticPaths() {
  const posts = await fetchPosts({ per_page: 100 });
  
  if (!posts) return [];
  
  return posts.map((post: { slug: any; }) => ({
    params: { slug: post.slug },
    props: { post }
  }));
}

const { slug } = Astro.params;
const { post } = Astro.props;

const currentPost = post || await fetchPostBySlug(slug);

if (!currentPost) {
  return Astro.redirect('/404');
}

const featuredImage = getFeaturedImage(currentPost);
const author = getAuthor(currentPost);
const publishDate = formatDate((currentPost as any)?.date ?? '');
const seoData = getSEOData(currentPost);
const readingTime = (currentPost as any)?.reading_time ?? 1;

// Fetch related posts
const relatedPosts = await fetchPosts({
  per_page: 3,
  exclude: (currentPost as any)?.id
});

export const prerender = true;
---

<Layout 
  title={seoData.title}
  description={seoData.description}
  image={seoData.image}
>
  <article class="container mx-auto px-4 py-16 max-w-4xl">
    <!-- Featured Image -->
    {featuredImage && (
      <div class="mb-8">
        <img 
          src={featuredImage.sizes.large || featuredImage.sizes.full}
          alt={featuredImage.alt}
          class="w-full h-64 md:h-96 object-cover rounded-lg"
        />
      </div>
    )}
    
    <!-- Article Header -->
    <header class="mb-8">
      <h1 class="text-4xl md:text-5xl font-bold mb-4">
        {(currentPost as any)?.title?.rendered ?? ''}
      </h1>
      
      <div class="flex flex-wrap items-center gap-4 text-gray-600 mb-4">
        <time datetime={(currentPost as any)?.date}>{publishDate}</time>
        <span>•</span>
        <span>{readingTime} min read</span>
        {author && (
          <>
            <span>•</span>
            <span>Written by {author.name}</span>
          </>
        )}
      </div>
    </header>
    
    <!-- Article Content -->
    <div class="prose prose-lg max-w-none mb-12" set:html={(currentPost as any)?.content?.rendered ?? ''} />
    
    <!-- Author Bio -->
    {author && (
      <div class="border-t pt-8 mb-12">
        <div class="flex items-start space-x-4">
          {author.avatar && (
            <img 
              src={author.avatar}
              alt={`${author.name} avatar`}
              class="w-16 h-16 rounded-full"
            />
          )}
          <div class="flex-1">
            <h3 class="font-semibold text-lg mb-2">About {author.name}</h3>
            {author.description && (
              <p class="text-gray-600 mb-2">{author.description}</p>
            )}
            {author.url && (
              <a 
                href={author.url}
                class="text-blue-600 hover:text-blue-800 text-sm"
                target="_blank"
                rel="noopener noreferrer"
              >
                Visit website →
              </a>
            )}
          </div>
        </div>
      </div>
    )}
    
    <!-- Related Posts -->
    {relatedPosts && relatedPosts.length > 0 && (
      <section class="border-t pt-8">
        <h3 class="text-2xl font-bold mb-6">Related Posts</h3>
        <div class="grid md:grid-cols-3 gap-6">
          {relatedPosts.map((relatedPost: { date: any; slug: any; title: { rendered: unknown; }; }) => {
            const relatedImage = getFeaturedImage(relatedPost);
            const relatedDate = formatDate(relatedPost.date);
            
            return (
              <article class="group">
                <a href={`/blog/${relatedPost.slug}`}>
                  {relatedImage && (
                    <div class="mb-3 overflow-hidden rounded-md">
                      <img 
                        src={relatedImage.sizes.medium || relatedImage.sizes.large}
                        alt={relatedImage.alt}
                        class="w-full h-32 object-cover group-hover:scale-105 transition-transform duration-300"
                      />
                    </div>
                  )}
                  <h4 class="font-medium mb-2 group-hover:text-blue-600 transition-colors line-clamp-2" 
                      set:html={relatedPost.title.rendered} />
                  <p class="text-gray-600 text-sm">{relatedDate}</p>
                </a>
              </article>
            );
          })}
        </div>
      </section>
    )}
  </article>
</Layout>